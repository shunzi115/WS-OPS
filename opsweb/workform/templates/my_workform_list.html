{% extends "public/layout.html" %}

{% load get_approver_process_result %}

{% block css %}
    <link rel="stylesheet" type="text/css" href="/static/plugin/Bootstrap-Wizard-master/css/bwizard.min.css">
{% endblock %}

{% block breadcrumb %} 
    工单系统 / <strong class="active">我的工单</strong>
{% endblock %}

{% block body %} 
<div class="bs-example bs-example-tabs" data-example-id="togglable-tabs">
    <ul id="myTabs" class="nav nav-tabs nav-justified" role="tablist">
        <li role="presentation" class="active">
            <a href="#my_workform_list" id="my_workform_list_tab" role="tab" data-toggle="tab" aria-controls="my_workform" aria-expanded="true">我 "发出/待审核" 的工单</a>
        </li>
        <li role="presentation">
            <a href="#my_audit_workform_list" role="tab" id="my_audit_workform_list_tab" data-toggle="tab" aria-controls="my_audit_workform" aria-expanded="false">我 "审核过" 的工单</a>
        </li>
    </ul>
    <div id="myTabContent" class="tab-content">
        <div role="tabpanel" class="tab-pane fade active in" id="my_workform_list" aria-labelledby="home-tab">
            <div class="col-sm-12">
                <table class="table table-striped table-bordered table-hover">
                    <caption style="padding-top: 0px;padding-bottom: 10px;">
                        <div>
                            <form class="form-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary" style="float:right">搜索</button>
                                <div class="form-group" style="text-align:right;float: right;margin-right: 10px;">
                                    <input type="text" class="form-control" name="search" value="{{ search }}" placeholder="主题 | 模块名 | 详情">
                                </div>
                            </form> 
                        </div>
                    </caption>  
                    <thead>
                        <tr>
                            <th class="text-center">主题</th>
                            <th class="text-center">申请人</th>
                            <th class="text-center">紧急程度</th>
                            <th class="text-center">类型</th>
                            <th class="text-center">上线原因</th>
                            <th class="text-center">模块名称</th>
                            <th class="text-center">是否有SQL</th>
                            <th class="text-center">工单状态</th>
                            <th class="text-center">待 审批/执行 流程</th>
                            <th class="text-center">已 审批/执行 流程状态</th>
                            <th class="text-center">创建时间</th>
                            <th class="text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pub in object_list %}
                        <tr class="gradeX">
                            <td class="text-center" style="vertical-align: middle"><strong>{{ pub.title|truncatechars:10 }}</strong></td>
                            <td class="text-center" style="vertical-align: middle">{{ pub.applicant.userextend.cn_name }}</td>
                            <td class="text-center" style="vertical-align: middle">
                                {% for i in level_range %}
                                    {% if i >= pub.level %}
                                        <span class="fa fa-star fa-fw" style="color: #F00"></span>
                                    {% endif %}
                                {% endfor %}
                            </td>
                            <td class="text-center" style="vertical-align: middle">{{ pub.type.cn_name }}</td>
                            <td class="text-center" style="vertical-align: middle">{{ pub.get_reason_display }}</td>
                            <td class="text-center" style="vertical-align: middle">{{ pub.module_name | default_if_none:"" }}</td>

                            {% if pub.sql == 'yes' %}
                                <td class="text-center" style="vertical-align: middle"><span class="badge label-primary">{{ pub.get_sql_display }}</span></td>
                            {% else %}
                                <td class="text-center" style="vertical-align: middle"><span class="badge label-default">{{ pub.get_sql_display }}</span></td>
                            {% endif %}

                            {% if pub.status == '0' %}
                                <td class="text-center"><span class="badge label-primary">{{ pub.get_status_display }}</span></td>
                            {% elif pub.status == '1' %}
                                <td class="text-center"><span class="badge label-success">{{ pub.get_status_display }}</span></td>
                            {% elif pub.status == '2' %}
                                <td class="text-center"><span class="badge label-warnning">{{ pub.get_status_display }}</span></td>
                            {% else %}
                                <td class="text-center"><span class="badge label-danger">{{ pub.get_status_display }}</span></td>
                            {% endif %}

                            <td class="text-center" style="vertical-align: middle">{{ pub.process_step.step }}</td>
                            <td class="text-center" style="vertical-align: middle">{{ pub | get_approver_result|safe }}</td>
                            <td class="text-center" style="vertical-align: middle">{{ pub.create_time|date:"Y-m-d H:i:s" }}</td>
                            <td class="text-center" style="vertical-align: middle">
                                {% if pub.type.name == 'firewall_require' %}
                                    <button class="btn btn-sm btn-info"><a target='_blank' href="{% url 'firewall_workform_detail' %}?id={{ pub.id }}" style="color: #f4f8fa">详情</a></button>
                                {% else %}
                                    <button data-id="{{ pub.id }}" class="btn btn-sm btn-info workform_detail">更多信息</button>
                                {% endif %}
                                <button data-id="{{ pub.id }}" class="btn btn-sm btn-primary process_trace">流程跟踪</button>
                                {% if user in pub.approver_can.all and  pub.process_step.step_id != 60 %}
                                    <button data-id="{{ pub.id }}" process-id="{{ pub.process_step_id }}" class="btn btn-sm btn-warning process_approval">审批</button>
                                {% endif %}
                                <!-- 只有到 OPS审批 的环节才会展示去执行SQL的按钮-->
                                {% if user in pub.approver_can.all and  pub.process_step.step_id == 30 and pub.sql == 'yes' %}
                                    <a href="{% url 'inception_sql_noexec_list' %}?id={{ pub.id }}" class="btn btn-sm btn-danger">执行SQL</a>
                                {% endif %}
                                {% if pub.status == '0' and user == pub.applicant %}
                                    <button data-id="{{ pub.id }}" data-del="{{ pub.title }}" class="btn btn-sm btn-danger del-btn">删除</button>
                                {% elif pub.status != '0' and user == pub.applicant %}
                                    <button data-id="{{ pub.id }}" data-del="{{ pub.title }}" class="btn btn-sm btn-danger del-btn" disabled="disabled">删除</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <!-- 列表分页 -->
                <div class="text-center">
                    <ul class="pagination">
                        <li class="disabled"><a href="#">总页数: {{ page_obj.paginator.num_pages }}</a></li>

                        {% if page_obj.number != 1 %}
                            <li><a href={% url "my_workform_list" %}?page=1{{ search_uri }}>首页</a></li>
                        {% else %}
                            <li class="disabled"><a href="#">首页</a></li>
                        {% endif %}

                        {% if page_obj.has_previous %}
                            <li><a href={% url "workform_list" %}?page={{ page_obj.previous_page_number }}{{ search_uri }}>上一页</a></li>
                        {% else %}
                            <li class="disabled"><a href="#">上一页</a></li>
                        {% endif %}

                        {% for page in page_range %}
                            {% if page == page_obj.number %}
                                <li class="active"><a href={% url "my_workform_list" %}?page={{ page }}{{ search_uri }}>{{ page }}</a></li>
                            {% else %}
                                <li><a href={% url "my_workform_list" %}?page={{ page }}{{ search_uri }}>{{ page }}</a></li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <li><a href={% url "my_workform_list" %}?page={{ page_obj.next_page_number }}{{ search_uri }}>下一页</a></li>
                        {% else %}
                            <li class="disabled"><a href="#">下一页</a></li>
                        {% endif %}
            
                        {% if page_obj.number != page_obj.paginator.num_pages %}
                            <li><a href={% url "my_workform_list" %}?page={{ page_obj.paginator.num_pages }}{{ search_uri }}>末页</a></li>
                        {% else %}
                            <li class="disabled"><a href="#">末页</a></li>
                        {% endif %}

                        <li class="disabled"><a href="#">总条数: {{ page_obj.paginator.count }}</a></li>
                    </ul>
                </div>
                <!-- 分页结束 -->    

                <!-- 删除模态框 -->
                <div class="modal fade" id='DeleteModal'>
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                <h4 class="modal-title">删除</h4>
                            </div>
                            <div class="modal-body">
                                <p id="data-del"></p>
                                <p style="color:red"><b>你确认要删除吗?</b></p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-warning del-sure" data-id=''>确认</button>
                            </div>
                        </div><!-- /.modal-content -->
                    </div><!-- /.modal-dialog -->
                </div><!-- /.modal -->
            </div>
        </div>

        <!-- 我审核过的工单 -->
        <div role="tabpanel" class="tab-pane fade" id="my_audit_workform_list" aria-labelledby="profile-tab">
            <br>
            <div class="col-sm-12">
                <table class="table table-striped table-bordered table-hover" id="my_audit_table">
                    <thead>
                        <tr>
                            <th class="text-center">主题</th>
                            <th class="text-center">申请人</th>
                            <th class="text-center">紧急程度</th>
                            <th class="text-center">类型</th>
                            <th class="text-center">上线原因</th>
                            <th class="text-center col-sm-2">模块名称</th>
                            <th class="text-center">是否有SQL</th>
                            <th class="text-center">工单状态</th>
                            <th class="text-center">待 审批/执行 流程</th>
                            <th class="text-center">已 审批/执行 流程状态</th>
                            <th class="text-center">创建时间</th>
                            <th class="text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="my_audit_list_tbody">
                        {% for my_approvaled in approvaled_workform_list %}
                        <tr class="gradeX">
                            <td class="text-center" style="vertical-align: middle"><strong>{{ my_approvaled.title|truncatechars:10 }}</strong></td>
                            <td class="text-center" style="vertical-align: middle">{{ my_approvaled.applicant.userextend.cn_name }}</td>
                            <td class="text-center" style="vertical-align: middle">
                                {% for i in level_range %}
                                    {% if i >= my_approvaled.level %}
                                        <span class="fa fa-star fa-fw" style="color: #F00"></span>
                                    {% endif %}
                                {% endfor %}
                            </td>
                            <td class="text-center" style="vertical-align: middle">{{ my_approvaled.type.cn_name }}</td>
                            <td class="text-center" style="vertical-align: middle">{{ my_approvaled.get_reason_display }}</td>
                            <td class="text-center" style="vertical-align: middle">{{ my_approvaled.module_name | default_if_none:""  }}</td>

                            {% if my_approvaled.sql == 'yes' %}
                                <td class="text-center" style="vertical-align: middle"><span class="badge label-primary">{{ my_approvaled.get_sql_display }}</span></td>
                            {% else %}
                                <td class="text-center" style="vertical-align: middle"><span class="badge label-default">{{ my_approvaled.get_sql_display }}</span></td>
                            {% endif %}

                            {% if my_approvaled.status == '0' %}
                                <td class="text-center"><span class="badge label-primary">{{ my_approvaled.get_status_display }}</span></td>
                            {% elif my_approvaled.status == '1' %}
                                <td class="text-center"><span class="badge label-success">{{ my_approvaled.get_status_display }}</span></td>
                            {% elif my_approvaled.status == '2' %}
                                <td class="text-center"><span class="badge label-warnning">{{ my_approvaled.get_status_display }}</span></td>
                            {% else %}
                                <td class="text-center"><span class="badge label-danger">{{ my_approvaled.get_status_display }}</span></td>
                            {% endif %}

                            <td class="text-center" style="vertical-align: middle">{{ my_approvaled.process_step.step }}</td>
                            <td class="text-center" style="vertical-align: middle">{{ my_approvaled | get_approver_result|safe }}</td>
                            <td class="text-center" style="vertical-align: middle">{{ my_approvaled.create_time|date:"Y-m-d H:i:s" }}</td>
                            <td class="text-center" style="vertical-align: middle">
                                {% if my_approvaled.type.name == 'firewall_require' %}
                                    <button class="btn btn-sm btn-info"><a target='_blank' href="{% url 'firewall_workform_detail' %}?id={{ my_approvaled.id }}" style="color: #f4f8fa">详情</a></button>
                                {% else %}
                                    <button data-id="{{ my_approvaled.id }}" class="btn btn-sm btn-info workform_detail">更多信息</button>
                                {% endif %}
                                <button data-id="{{ my_approvaled.id }}" class="btn btn-sm btn-primary process_trace">流程跟踪</button>
                            </td>
                        </tr>
                        {% endfor %} 
                    </tbody>
                </table> 
            </div>
        </div>

        <!-- 更多信息模态框 -->
        <div class="modal fade"  id ="MyWorkFormDetailModal">   
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title">工单更多信息</h4>
                    </div>
                    <div class="modal-body">
                        <form id="MyWorkFormDetailForm" class="Formvalid form-horizontal nice-validator n-yellow" novalidate="novalidate">
                            {% csrf_token %}
                            <input type="hidden" name="id" id='id'>

                            <div class="form-inline row">  
                                <div class="form-group col-sm-12">
                                    <label for="title" style="width:15%" class="control-label text-right">工单标题 <span class="red-fonts">*&nbsp</span></label>
                                    <input id='title' name="title" style="width: 79%;" type="text" class="form-control" aria-required="true" readonly>
                                </div>
                            </div>

                            <div class="hr-line-dashed"></div>
                            <div class="form-inline row">  
                                <div class="form-group col-sm-12">
                                    <label for="detail" style="width:15%" class="control-label text-right">工单说明 <span class="red-fonts">*&nbsp</span></label>
                                    <textarea id='detail' name="detail" style="width: 79%;" class="form-control" aria-required="true" rows="5" readonly>
                                    </textarea>
                                </div>
                            </div>

                            <div class="hr-line-dashed"></div>
                            <div class="form-inline row">
                                <div class="form-group col-sm-6">
                                    <label for="create_time" style="width:30%" class="control-label text-right">创建时间 &nbsp</label>
                                    &nbsp<input id='create_time' name="create_time" style="width:65%" type="text" class="form-control" aria-required="true" readonly>
                                </div>

                                <div class="form-group col-sm-6">
                                    <label for="complete_time" style="width:30%" class="control-label text-right">完成时间 &nbsp</label>
                                    <input id='complete_time' name="complete_time" style="width:65%" type="text" class="form-control" aria-required="true" readonly>
                                </div>
                            </div>
                        </form>
                    </div>
                    <p style="font-size: 4px;text-align: center">
                        <i class="fa fa-exclamation-circle"></i>
                        对于包含<strong style="color:red">SQL</strong>的工单,如果SQL未执行则<strong style="color:red">SQL详情</strong>展示的是<strong><i> SQL检查 </i></strong>结果，否则是<strong><i> SQL执行后  </i></strong>的结果
                    </p>
                    <div class="modal-footer">
                        <a href="#" target="_blank" id="mysql_info" class="btn btn-info">SQL 详情</a>
                        <button class="btn btn-warning exit-btn" data-dismiss="modal">退出</button>
                    </div>
                </div><!-- .modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

        <!-- 审批模态框 -->
        <div class="modal fade"  id ="MyApprovalWorkFormModal">   
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h2 class="modal-title text-center" id="approval-head"></h2>
                    </div>
                    <div class="modal-body">
                        <form id="MyApprovalWorkForm" class="Formvalid form-horizontal nice-validator n-yellow" novalidate="novalidate">
                            {% csrf_token %}
                            <input type="hidden" name="id" id='id_approval'>
                            <input type="hidden" name="process_step_id" id='step_id_approval'>

                            <div class="form-inline row">  
                                <div class="form-group col-sm-12">
                                    <label for="title" style="width:15%" class="control-label text-right">工单标题 <span class="red-fonts">*&nbsp</span></label>
                                    <input id='title_approval' name="title" style="width: 79%;" type="text" class="form-control" aria-required="true" readonly>
                                </div>
                            </div>

                            <div class="hr-line-dashed"></div>
                            <div class="form-inline row" id="module_name_approval_div">  
                                <div class="form-group col-sm-12">
                                    <label for="module_name" style="width:15%" class="control-label text-right">模块名称 <span class="red-fonts">*&nbsp</span></label>
                                    <input id='module_name_approval' name="module_name" style="width: 79%;" type="text" class="form-control" aria-required="true" readonly>
                                </div>
                            </div>

                            <div class="hr-line-dashed"></div>
                            <div class="form-inline row">  
                                <div class="form-group col-sm-12">
                                    <label for="detail" style="width:15%" class="control-label text-right">工单说明 <span class="red-fonts">*&nbsp</span></label>
                                    <textarea id='detail_approval' name="detail" style="width: 79%;" class="form-control" aria-required="true" rows="5" readonly>
                                    </textarea>
                                </div>
                            </div>

                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="control-label col-sm-2" >审批结果 <span class="red-fonts">*</span></label>
                                <div class="col-sm-8">
                                    {% for k,v in approval_result.items %}
                                    <div class="col-sm-3">
                                        <div class="radio i-checks">
                                            <label><input type="radio" value="{{ k }}" name="result">{{ v }}</label>
                                        </div>
                                    </div>
                                    {% endfor %}        
                                </div>
                            </div>

                            <div class="hr-line-dashed"></div>
                            <div class="form-inline row">
                                <div class="form-group col-sm-12">
                                    <label for="approve_note" style="width:15%" class="control-label text-right">审批意见 <span class="red-fonts">*&nbsp</span></label>
                                    <textarea  name="approve_note" style="width: 79%;" class="form-control" aria-required="true" rows="5">
                                    </textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                    <p style="font-size: 4px;text-align: center">
                        <i class="fa fa-exclamation-circle"></i>
                        如果工单中包含<strong style="color:red">SQL</strong>需要先<strong style="color:red">检查SQL</strong>然后才能审批
                    </p>
                    <div class="modal-footer" style="text-align: center">
                        <a href="#" target="_blank" id="approval_sql_check" class="btn btn-info">检查 SQL</a>
                        <button id="approval_submit" class="btn btn-primary">审批</button>
                        <button class="btn btn-warning exit-btn" data-dismiss="modal">退出</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

        <!-- 流程跟踪模态框 -->
        <div class="modal fade" id='ProcessTraceModal'>
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title">流程跟踪</h4>
                    </div>
                    <div class="modal-body" style="padding: 20px 30px 0px 30px;">
                        <div class="container-fluid">
                            <div class="bwizard clearfix" style="text-align: center">
                                <ol class="bwizard-steps clearfix clickable" role="tablist" id="process_ul">
                                </ol>
                                <div class="well row" style="background-color: white;border: none;">
                                    <h2 style="margin-bottom: 20px;margin-top:2px" id="process_head"></h2>
                                    <form class="form-horizontal col-sm-offset-2" id="ProcessTraceForm" style="margin-bottom: 0px;text-align:center">
                                    {% csrf_token %}
                                        <div class="form-group">
                                            <label for="approver" class="col-sm-2 control-label  ">审批/执行人</label>
                                            <div class="col-sm-6">
                                                <input id="approver" name="approver" type="text" class="form-control" aria-required="true">
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label for="result" class="col-sm-2 control-label">审批/执行结果</label>
                                            <div class="col-sm-6">
                                                <input id="result" name="result" type="text" class="form-control" aria-required="true">
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label for="approval_note" class="col-sm-2 control-label">审批意见</label>
                                            <div class="col-sm-6">
                                                <textarea id="approval_note" name="approval_note" class="form-control" aria-required="true" rows="3">
                                                </textarea>
                                            </div>
                                        </div> 

                                        <div class="form-group">
                                            <label for="approval_time" class="col-sm-2 control-label">审批/执行时间</label>
                                            <div class="col-sm-6">
                                                <input id="approval_time" name="approval_time" type="text" class="form-control" aria-required="true">
                                            </div>
                                        </div>
                                    </form> 
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary exit-btn" data-dismiss="modal">退出</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

    </div>
</div>
{% endblock %}

{% block js %}

<script>

datatable_list()

<!-- SQL 检查 -->
$(document).on("click","#approval_sql_check",function(){
    $("#approval_submit").prop("disabled",false)
});
<!-- 结束 -->

<!--审批-->
$(document).on("click",".process_approval",function(){
    $("#approval_sql_check").attr('style','display:none')
    $("#module_name_approval_div").removeAttr('style')
    var id = $(this).attr("data-id")
    var process_id = $(this).attr("process-id")
    var url = "{% url 'workform_approval' %}?id="+id+"&process_id="+process_id
    $.getJSON(url,function(data){
        if(data.result==0){
            data = data.wf_info
            console.log(data)
            $("#id_approval").val(data.id)
            $("#title_approval").val(data.title)
            $("#detail_approval").val(data.detail)
            $("#step_id_approval").val(data.process_step_id_id)
            if(data.type=='publish' || data.type=='rollback'){
                $("#module_name_approval").val(data.module_name)
            }else{
                $("#module_name_approval").val('')
                $("#module_name_approval_div").attr('style','display:none')
            };
            $("#approval-head").text(data.process)
            <!-- 如果 存在SQL,那么 '运维审核'前后，这个模态框下的 'sql 检查'按钮 是否需要展示 -->
            if(data.sql=='yes'&& data.process_step_id !=30 ){
                $("#approval_sql_check").removeAttr('style')
                $("#approval_submit").prop("disabled",true)
                if(data.sql_exec_if==0){
                    $("#approval_sql_check").attr("href","{% url 'workform_sql_exec_result' %}?id="+data.id)
                }else{
                    $("#approval_sql_check").attr("href","{% url 'workform_sql_check' %}?id="+data.id)
                };
            };
            $("#MyApprovalWorkFormModal").modal("show")
        }else{
            swal("OH,My God",data.msg,"error")
        }
    })
});

$("#approval_submit").click(function(){
     if($(this).attr("disabled")){
        return false
    };
    var str = $("#MyApprovalWorkForm").serialize()
    var url = "{% url 'workform_approval' %}"
    $.post(url,str,function(data){
        if(data.result==0){
           $('#MyApprovalWorkFormModal').modal('hide')
           swal({
             title:"Good",
             text:data.msg,
             type:'success',
             confirmButtonText:"确定"
             },
             function(){
                location.reload()
           })
       }else{
            swal("OH,My God",data.msg,"error")
       }; 
    })
    return false
});
<!-- 结束 -->

<!-- 更多信息 -->
$(document).on("click",".workform_detail",function(){
    $("#mysql_info").attr('style','display:none')
    var id = $(this).attr("data-id")
    var url = "{% url 'workform_info' %}?id="+id
    $.getJSON(url,function(data){
        if(data.result==0){
            data = data.wf_info
            console.log(data)
            $("#id").val(data.id)
            $("#title").val(data.title)
            $("#detail").val(data.detail)
            $("#create_time").val(data.create_time)
            $("#complete_time").val(data.complete_time)
            <!-- 如果 存在SQL,那么 sql执行前后，这个模态框下的 'sql 详情'按钮 展示的内容是不一样的 -->
            if(data.sql=='yes'){
                $("#mysql_info").removeAttr('style')
                if(data.sql_exec_if==0){
                    $("#mysql_info").attr("href","{% url 'workform_sql_exec_result' %}?id="+data.id)
                }else{
                    $("#mysql_info").attr("href","{% url 'workform_sql_check' %}?id="+data.id)
                };
            };
            $("#MyWorkFormDetailModal").modal("show")
        }else{
            swal("OH,My God",data.msg,"error")
        }
    });
});

<!--流程跟踪-->
$(document).on("click",".process_trace",function(){
    $(".well input").val('')
    $(".well textarea").val('')
    $(".well h2").text('')
    var id = $(this).attr("data-id")
    var url = "{% url 'process_trace' %}"
    $.post(url,{"id":id},function(data){
        if(data.result==0){
            data = data.process_list
            var str = ''
            $.each(data,function(k,v){
                if(v.result && v.process_step_id!=60){
                    str += '<li role="tab" aria-selected="false" class="active">'
                    str += '<span class="label badge-inverse">'+ k + '</span>'
                    str += '<a href="#" class="process_step_trace" data-id="' + v.id + '">' + v.process + '</a></li>'
                    $("#process_head").text(v.process)
                    $("#approver").val(v.approver)
                    $("#result").val(v.result)
                    $("#approval_note").val(v.approve_note)
                    $("#approval_time").val(v.approve_time)
                }else if(v.result && v.process_step_id==60){
                    str += '<li role="tab" aria-selected="false" class="active">'
                    str += '<span class="label badge-inverse">'+ k + '</span>'
                    str += v.process + '</li>'
                }else{
                    str += '<li role="tab" aria-selected="true">'
                    str += '<span class="label badge-inverse">'+ k + '</span>'
                    str += v.process + '</li>'
                }
            });
            $("#process_ul").html(str)
            $("#ProcessTraceModal").modal("show")
        }else{
            swal("OH,My God",data.msg,"error")
        }; 
    });
    return false;
});

$(document).on("click",".process_step_trace",function(){
    var id = $(this).attr("data-id")
    var url = "{% url 'process_step_approval' %}?id=" + id
    $.getJSON(url,function(data){
        if(data.result==0){
            data = data["approval_info"]
            $("#process_head").text(data.process)
            $("#approver").val(data.approver)
            $("#result").val(data.result)
            $("#approval_note").val(data.approve_note)
            $("#approval_time").val(data.approve_time) 
        }else{
            swal("OH,My God",data.msg,"error")
        }
    });
});
<!--结束-->

<!--删除-->
$(".del-btn").click(function(){
    var id = $(this).attr("data-id")
    var data = $(this).attr("data-del")
    $(".del-sure").attr('data-id',id)
    $("#data-del").html(data)
    $("#DeleteModal").modal("show")
});

$(".del-sure").click(function(){
   var id = $(this).attr('data-id')
   var url = "{% url 'workform_delete' %}"
   $('#DeleteModal').modal('hide')
   $.post(url,{"id": id},function(data){
       if(data.result==0){
           swal({
             title:"Good",
             text:data.msg,
             type:'success',
             confirmButtonText:"确定"
             },
             function(){
                location.reload()
           })
       }else{
            swal("OH,My God",data.msg,"error")
       };
   });
   return false;
});
<!-- 结束 -->

function datatable_list(){
  $("#my_audit_table").dataTable({
      "autoWidth":true,
      "ordering": false,
      "bDestroy":true,
      "order": [[ 0, "asc" ]],
      "bStateSave": true,
      "sPaginationType": "full_numbers",
      "language":{
            "lengthMenu":"每页 _MENU_ 条记录",
            "zeroRecords":"没有找到记录",
            "sInfo": "第 _PAGE_ 页 ( 总共 _PAGES_ 页 ),显示第 _START_ 至 _END_ 项(总共 _TOTAL_ 项)",
            "infoEmpty": "无记录",
            "infoFiltered": "(从 _MAX_ 条记录过滤)",
            "sSearch": "搜索:",
            "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "上一页",
                    "sNext": "下一页",
                    "sLast": "末页"
            }
      }
  })
};

</script>

{% endblock %}

